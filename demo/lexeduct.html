<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <title>Lexeduct</title>
</head>
<body>

<header>
  <h1>Lexeduct</h1>
</header>

<div id="container"></div>

</body>
<script src="lexeduct-browser.js"></script>
<script src="yoob/element-factory.js"></script>
<script>
"use strict";

var compose = function(g, f) {
    return function(str, data) {
        str = f(str, data);
        return g(str, data);
    };
};

var container, input, output, processButton, tranformersPanel;

container = document.getElementById('container');
input = yoob.makeTextArea(container, 40, 20, "Hello, there!\nWhat do you think?");

var transformersPanel = yoob.makeDiv(container);
transformersPanel.style.border = "2px solid black";
transformersPanel.style.display = "inline-block";
transformersPanel.style.verticalAlign = "top";

var MAX_TRANSFORMER_SLOTS = 8; // TODO dynamic
var transformerSlots = [];

var transformerNames = [["identity", "---"]];
for (var key in transformer) {
    if (key !== 'identity' && transformer.hasOwnProperty(key)) {
        transformerNames.push([key, key]);
    }
}

var parseOptions = function(text) {
    var args = text.split(' ');
    var cfg = {};
    for (var i = 0; i < args.length; i++) {
        var paramPair = args[i].split('=');
        if (paramPair.length == 2) {
            cfg[paramPair[0]] = paramPair[1];
        } else {
            // register an error
        }
    }
    return cfg;
};

var process = function() {
    var t = transformer['identity'].makeTransformer({});
    for (var i = 0; i < transformerSlots.length; i++) {
        var select = transformerSlots[i].select;
        var transformerName = select.options[select.selectedIndex].value;
        var params = parseOptions(transformerSlots[i].optionsInput.value);
        var t2 = transformer[transformerName].makeTransformer(params);
        t = compose(t2, t);
    }
    var inLines = input.value.split('\n');
    var outLines = [];
    for (var i = 0; i < inLines.length; i++) {
        outLines.push(t(inLines[i]));
    }
    output.value = outLines.join('\n');
};

processButton = yoob.makeButton(transformersPanel, "Process", process);

var liveMode;
yoob.makeCheckbox(transformersPanel, false, "Live mode", function(b) {
    liveMode = b;
});
yoob.makeLineBreak(transformersPanel);

var updateParametersPanel = function(panel, parameters) {
    panel.innerHTML = "";  // delete any previous controls
    for (var key in parameters) {
        if (parameters.hasOwnProperty(key)) {
            var label = yoob.makeSpan(panel, key);
            label.style.width = "50%";
            var input = yoob.makeTextInput(panel, 24);
            input.style.width = "50%";
            // TODO: populate it with the default
            input.onchange = function() {
                alert('TODO: update transformerSlots.selectedParameters or smth here');
                if (liveMode) {
                    process();
                }
            }
            yoob.makeLineBreak(panel);
        }
    }
};

var makeTransformerSlot = function(container, index) {
    var select = yoob.makeSelect(
        transformersPanel, "Transformer " + (i+1), transformerNames
    );
    yoob.makeLineBreak(transformersPanel);
    var parametersPanel = yoob.makeDiv(transformersPanel);
    select.onchange = function(e) {
        if (liveMode) {
            process();
        }
        updateParametersPanel(parametersPanel);
    };

    //------------ deprecated...
    var optionsInput = yoob.makeTextInput(transformersPanel, 24);
    optionsInput.onchange = function(e) {
        if (liveMode) {
            process();
        }
    };
    optionsInput.title = "Options";
    yoob.makeLineBreak(transformersPanel);
    //------------

    return {
        select: select,
        optionsInput: optionsInput,
        parametersPanel: parametersPanel
    };
};

for (var i = 0; i < MAX_TRANSFORMER_SLOTS; i++) {
    var slot = makeTransformerSlot(transformersPanel, index);
    transformerSlots.push(slot);
}

output = yoob.makeTextArea(container, 40, 20);
</script>
